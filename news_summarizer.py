import time
import os
from zhipuai import ZhipuAI

api_key = os.getenv('ZHIPUAI_API_KEY')
if api_key is None:
    raise ValueError("Please set ZHIPUAI_API_KEY environment variable")

client = ZhipuAI(api_key=api_key)

input_text = """
上市券商首现在三季度现金分红。

　　根据相关公告，首创证券(21.130, -0.44, -2.04%)、山西证券(6.460, 0.10, 1.57%)、南京证券(8.880, -0.18, -1.99%)、财通证券(8.200, -0.07, -0.85%)、西部证券(8.060, -0.14, -1.71%)、西南证券(4.750, -0.06, -1.25%)拟进行前三季度利润分配，合计拟派发现金红利约8.93亿元。

　　虽然从业绩表现来看，上述6家券商中不乏“失速”者，但仍大方出手。其中，西部证券和西南证券均是在中报分红基础上，再推出了分红计划。

　　南开大学金融发展研究院院长田利辉对券商中国记者表示，券商分红并非越多越好，需要考量多种因素，兼顾公司长远发展与股东利益。

　　2家券商年内或实施三次现金分红

　　三季报收官，明显可见上市公司分红积极性显著提高，215家公司披露了三季度分红预案。其中多数公司都是首次三季度分红，里面也包括了6家券商，这开启了上市券商首次三季度分红的历史纪录。

　　其中，山西证券拟每10股派发现金红利0.50元，共派发1.79亿元；西南证券拟每10股派发0.1元，实际分配利润为0.66亿元；西部证券拟每10股��发0.20元，拟分配股利0.89亿元；财通证券拟每10股派发0.50元，共派发2.32亿元；首创证券拟每股派发0.055元，合计拟派发总额1.50亿元；南京证券拟每股派发0.048元，合计派发1.77亿元。以上拟派发现金红利金额均含税。

　　需要指出的是，上述6家券商均在今年完成了2023年度现金分红，并且西南证券和西部证券还实施了2024年年中分红，分别派发现金红利6645.11万元和4469.58万元。也就是说，算上2023年度分红，如果后续落地顺利，西南证券和西部证券年内将派发现金红利三次。

　　业绩“失速”，仍推出大手笔分红

　　实际上，从最新披露的三季报数据来看，上述6家券商，业绩并不都十分亮眼。其中，仅首创证券和南京证券实现了营收和净利润的双增长，且增幅都在两位数以上。山西证券营业收入为21.66亿元，同比减少12.46%，不过归母净利润实现正增长；前三季度净赚5.33亿元，同比增长57.83%。

　　西南证券、西部证券、财通证券前三季度的营收和归母净利润均遭遇下滑。仅从归母净利润角度看，西南证券为4.83亿元，同比下降15.29%；西部证券为7.29亿元，同比下滑16.82%；财通证券实现归母净利润14.72亿元，微降1.93%。

　　不过，从股利支付率角度看，虽然上述券业绩分化明显，不乏“失速”者，但并没有妨碍其大手笔现金分红。6家券商拟派发现金红利占归母净利润的比重在12.27%—33.68%。其中，山西证券为33.68%，南京证券为25.42%，首创证券为20.05%，财通证券为15.77%；西南证券和西部证券接近，分别为13.76%和12.27%。

　　“提高股东回报”是上述券商多次分红的原因之一。比如西南证券称，为积极响应监管号召，提高股东回报，推动一年多次分红，拟在2024年度中期利润分配基础上，拟进行前三季度利润分配。再如南京证券和山西证券均表示，是从公司发展和股东利益等因素综合考虑。

　　尚有10家券商中期分红未落地

　　其实，从上半年的分红情况看，已经能明显感受到上市券商更加大方了。

　　今年上半年，43家上市券商中，过半竞相推出现金分红方案，和往年选择中期分红券商数量屈指可数，形成明显反差。Wind显示，截至11月2日，2024年中期分红预案已经实施完毕的共有17家上市券商，合计分红53.74亿元（税前）。目前中期分红预案尚未实施的上市券商还有10家，合计约有46.84亿元现金“福利”将派发给各家券商股东。

　���在业内看来，上市券商积极分红，除响应政策号召、回报股东外，也有利于提升上市公司吸引力。尤其是随着高股息红利资产持续受到追捧，加大分红、多次分红有利于提高上市公司的估值。而对于市场而言，上市券商回报回报投资者意识和能力的提升，向市场传递积极信号，有利于提振投资者信心。

　　天风证券(5.820, -0.58, -9.06%)非银分析师杜鹏辉在研报中曾分析称，新“国九条”确立以分红为核心的上市企业质量评价体系，半强制性要求上市公司分红，对未来市场风格和投资范式影响深远。

　　杜鹏辉认为，过去，市场存在“高成长赛道过于拥挤，价值赛道无人问津”的问题。新“国九条”后，以分红为核心的政策变化或将有效重构市场估值体系。防止估值模型的过度简化，投资者需要审慎考量高增速的净利润能否实现到高增速的股息。

　　从近期券商策略分析师的研判来看，在一段时间内，高股息策略仍然有一定空间。不过，对于面临业绩考验和高资本投入的券商而言，分红并非越多越好。

　　田利辉认为，对于券商这类资本密集型公司，分红计划需考虑盈利能力与现金流，确保分红不影响公司正常运营和未来发展。同时也需考虑资产负债健康避免过度分红增加债务负担，以及考虑股东需求与结构，注重股东回报期望与股权稳定性。此外，券商也需考虑发展战略与资金需求，确保分红不与重大投资计划冲突。
"""

# 创建异步完成请求
try:
    response = client.chat.asyncCompletions.create(
        model="glm-4-flash",
        messages=[
            {"role": "system", "content": "我是沃伦·巴菲特。作为一位投资界的传奇人物，我会以简短的一两句话，从价值投资和长期回报的角度来评价这条新闻。我会保持我一贯的投资风格 - 关注基本面、现金流和可持续的商业模式。"},
            {"role": "user", "content": input_text}
        ]
    )
    task_id = response.id
    print(f"任务ID: {task_id}")  # 确认请求已发送
except Exception as e:
    print(f"创建异步请求时发生异常: {e}")
    exit(1)

task_status = ''
get_cnt = 0

while task_status not in ['SUCCESS', 'FAILED'] and get_cnt < 40:
    try:
        if task_id is None:
            print("任务ID为空")
            break
            
        result_response = client.chat.asyncCompletions.retrieve_completion_result(id=task_id)
        print(f"尝试 {get_cnt + 1}: 状态 - {result_response.task_status}")
        task_status = result_response.task_status
        if task_status == 'SUCCESS':
            if result_response.choices and len(result_response.choices) > 0:
                content = result_response.choices[0].message.content
                print("完成内容:")
                print(content)
            else:
                print("没有可用的完成内容。")
            break
        elif task_status == 'FAILED':
            print("请求失败")
            break
    except Exception as e:
        print(f"获取结果时发生异常: {e}")
        break

    time.sleep(2)
    get_cnt += 1

if get_cnt >= 40 and task_status not in ['SUCCESS', 'FAILED']:
    print("请求超时，未能在80秒内完成。")